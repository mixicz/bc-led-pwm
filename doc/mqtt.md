# MQTT Communication Logic for LED PWM Controller

This document summarizes the MQTT communication logic implemented in the `hardwario/led-pwm/app` firmware. It covers the topics, message flow, and the role of MQTT in controlling and monitoring the LED PWM device.

## Overview
The firmware uses MQTT for remote control and monitoring of LED strips and fans. It subscribes to specific topics to receive commands and publishes status and event information to other topics. The communication is based on the Hardwario MQTT topic conventions, without the `node/{id}/` prefix.

## MQTT Topics

### Subscribed Topics (Commands)
The firmware subscribes to the following topics to receive commands:

| Topic                          | Payload Type | Description                                      |
|------------------------------- |------------- |--------------------------------------------------|
| led-pwm/-/config/set           | string       | Set configuration for all LEDs                   |
| led-pwm/-/trigger/set          | int          | Trigger LEDs (increase trigger count)            |
| led-pwm/-/brightness/set       | float        | Set brightness for all LEDs [0..1]                  |
| led-pwm/{0-7}/brightness/set   | float        | Set brightness for specific LED [0..1]              |

#### Example Payloads
- `led-pwm/-/trigger/set`: `1` (triggers all LEDs, increases trigger count)
- `led-pwm/3/brightness/set`: `0.75` (sets brightness of LED 3 to 75%)

### Published Topics (Status & Events)
The firmware publishes status and event information to the following topics:

| Topic                          | Payload Type | Description                                      |
|------------------------------- |------------- |--------------------------------------------------|
| led-pwm/-/trigger/state        | int          | Current trigger count (max of all LEDs)          |
| event/-/brightness/state       | float        | Current brightness [0..1]                           |
| event/{N}/off                  | JSON         | LED off event: `{ "onTime":..., "triggerCount":... }` |
| thermometer/0:1/temperature    | float        | Measured temperature (°C)                        |
| fan/{N}/speed                  | float        | Current fan speed                                |
| fan/{N}/rpm                    | int          | Current fan RPM                                  |
| alert/temperature/critical     | float        | Critical temperature alert                       |
| alert/temperature/warning      | float        | Warning temperature alert                        |
| alert/trigger/error            | string       | Error (e.g., overheat detected)                  |
| alert/fan/rpm                  | int          | Fan RPM alert (fan not working)                  |

#### Example Published Messages
- `event/2/off`: `{ "onTime": 120, "triggerCount": 3 }`
- `fan/0/speed`: `0.75`
- `alert/temperature/critical`: `72.5`

## Message Flow

### Command Reception
- The firmware subscribes to command topics using a table (`mqtt_subs[]`) that maps topics to expected payload types and callback functions.
- When a message is received, the corresponding callback is invoked:
  - `led_trigger_set`: Increases trigger count, turns on LEDs, refreshes off timer, publishes new trigger state.
  - `led_brightness_set`: Sets brightness for one or all LEDs, publishes new brightness state.
  - `led_config_set`: (Commented out, but intended for configuration via JSON payload).

### Status & Event Publishing
- LED state changes (on/off) and brightness adjustments result in publishing to event topics.
- Temperature readings are published periodically and when significant changes occur.
- Fan speed and RPM are monitored and published regularly or on significant change.
- Alerts are published for overheat, fan failure, and other critical events.

## Example Sequence
1. **Trigger LED**: MQTT message to `led-pwm/-/trigger/set` with payload `1` → LEDs turn on, off timer refreshed, publishes new trigger state.
2. **Set Brightness**: MQTT message to `led-pwm/2/brightness/set` with payload `50.0` → LED 2 brightness set to 50%, publishes new brightness state.
3. **Temperature Alert**: If temperature exceeds threshold, publishes to `alert/temperature/critical` and turns off all LEDs.
4. **Fan RPM Alert**: If fan RPM is zero while speed > 0, publishes to `alert/fan/rpm`.

## References
- [Hardwario MQTT Topic Conventions](https://developers.hardwario.com/interfaces/mqtt-topics)
- See source code in `application.c` for implementation details.

---
*Generated by GitHub Copilot on 30. srpna 2025*
